generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(uuid())
  username        String   @unique
  email           String   @unique
  passwordHash    String   @map("password_hash")
  displayName     String?  @map("display_name")
  avatarUrl       String?  @map("avatar_url")
  totalXp         Int      @default(0) @map("total_xp")
  level           Int      @default(1)
  currentStreak   Int      @default(0) @map("current_streak")
  longestStreak   Int      @default(0) @map("longest_streak")
  lastPlayedDate  DateTime? @map("last_played_date") @db.Date
  isAdmin         Boolean  @default(false) @map("is_admin")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  progress        UserProgress[]
  answers         UserAnswer[]
  achievements    UserAchievement[]
  belts           UserBelt[]
  dailyChallenges UserDailyChallenge[]
  refreshTokens   RefreshToken[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model QuizCategory {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  iconUrl     String?  @map("icon_url")
  unlockLevel Int      @default(1) @map("unlock_level")
  colorTheme  String   @default("#0047AB") @map("color_theme")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  questions Question[]
  progress  UserProgress[]
  belts     ChampionshipBelt[]

  @@map("quiz_categories")
}

model Question {
  id            String       @id @default(uuid())
  categoryId    String       @map("category_id")
  questionText  String       @map("question_text") @db.Text
  questionType  QuestionType @default(MULTIPLE_CHOICE) @map("question_type")
  difficulty    Difficulty
  mediaUrl      String?      @map("media_url")
  correctAnswer String       @map("correct_answer")
  answerOptions Json         @map("answer_options")
  explanation   String?      @db.Text
  xpReward      Int          @map("xp_reward")
  timeLimit     Int          @map("time_limit")
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at")

  category QuizCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  answers  UserAnswer[]

  @@map("questions")
}

enum QuestionType {
  MULTIPLE_CHOICE
  IMAGE_ID
  AUDIO_CLIP
  TIMELINE

  @@map("question_type")
}

enum Difficulty {
  easy
  medium
  hard

  @@map("difficulty")
}

model UserProgress {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  categoryId        String   @map("category_id")
  questionsAnswered Int      @default(0) @map("questions_answered")
  questionsCorrect  Int      @default(0) @map("questions_correct")
  categoryXp        Int      @default(0) @map("category_xp")
  masteryLevel      Int      @default(0) @map("mastery_level")
  lastAttempted     DateTime? @map("last_attempted")
  createdAt         DateTime @default(now()) @map("created_at")

  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  category QuizCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@map("user_progress")
}

model UserAnswer {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  questionId String   @map("question_id")
  answerGiven String  @map("answer_given")
  isCorrect  Boolean  @map("is_correct")
  timeTaken  Int      @map("time_taken")
  xpEarned   Int      @map("xp_earned")
  answeredAt DateTime @default(now()) @map("answered_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("user_answers")
}

model Achievement {
  id             String    @id @default(uuid())
  name           String    @unique
  description    String?   @db.Text
  badgeIconUrl   String?   @map("badge_icon_url")
  unlockCriteria Json      @map("unlock_criteria")
  xpReward       Int       @map("xp_reward")
  beltTier       BeltTier? @map("belt_tier")
  createdAt      DateTime  @default(now()) @map("created_at")

  userAchievements UserAchievement[]

  @@map("achievements")
}

enum BeltTier {
  bronze
  silver
  gold
  championship

  @@map("belt_tier")
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  achievementId String   @map("achievement_id")
  unlockedAt    DateTime @default(now()) @map("unlocked_at")
  isEquipped    Boolean  @default(false) @map("is_equipped")

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model ChampionshipBelt {
  id                  String     @id @default(uuid())
  name                String     @unique
  description         String?    @db.Text
  beltImageUrl        String     @map("belt_image_url")
  categoryId          String?    @map("category_id")
  unlockCriteria      Json       @map("unlock_criteria")
  bigBlueCageProductUrl String?  @map("big_blue_cage_product_url")
  rarity              BeltRarity @default(common)
  createdAt           DateTime   @default(now()) @map("created_at")

  category  QuizCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  userBelts UserBelt[]

  @@map("championship_belts")
}

enum BeltRarity {
  common
  rare
  legendary

  @@map("belt_rarity")
}

model UserBelt {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  beltId      String   @map("belt_id")
  earnedAt    DateTime @default(now()) @map("earned_at")
  isDisplayed Boolean  @default(false) @map("is_displayed")

  user User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  belt ChampionshipBelt @relation(fields: [beltId], references: [id], onDelete: Cascade)

  @@unique([userId, beltId])
  @@map("user_belts")
}

model DailyChallenge {
  id            String   @id @default(uuid())
  challengeDate DateTime @unique @map("challenge_date") @db.Date
  questionIds   Json     @map("question_ids")
  bonusXp       Int      @map("bonus_xp")
  createdAt     DateTime @default(now()) @map("created_at")

  userChallenges UserDailyChallenge[]

  @@map("daily_challenges")
}

model UserDailyChallenge {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  challengeId String    @map("challenge_id")
  completed   Boolean   @default(false)
  score       Int       @default(0)
  completedAt DateTime? @map("completed_at")

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge DailyChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId])
  @@map("user_daily_challenges")
}
